<!DOCTYPE html>
<html>
<head>
  <title>Our AR Map Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <script>
    /* ---------- Dynamic Marker Interaction ---------- */
    AFRAME.registerComponent('marker-handler', {
      schema: {
        panelId: {type: 'string'} // We pass the ID of the panel we want to toggle
      },
      init: function () {
        const panel = document.querySelector(this.data.panelId);
        
        // This works for both screen taps AND the visual reticle (fuse)
        this.el.addEventListener('click', () => {
          const isVisible = panel.getAttribute('visible');
          // Close all other panels first (Optional - prevents clutter)
          document.querySelectorAll('.info-panel').forEach(p => p.setAttribute('visible', false));
          // Toggle this specific one
          panel.setAttribute('visible', !isVisible);
        });
      }
    });
  </script>

  <style>
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    button { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; }
    html, body { margin: 0; height: 100%; overflow: hidden; }
    a-scene { position: fixed; width: 100%; height: 100%; top: 0; left: 0; }
  </style>
</head>

<body>

<div id="overlay">
  <button id="startButton">Start AR Experience</button>
</div>

<a-scene
  mindar-image="imageTargetSrc: targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;"
  vr-mode-ui="enabled: false;"
  device-orientation-permission-ui="enabled: false">

  <a-assets>
    <img id="mapImage" src="Keystone Wall Wrap Old Photos/LakeMapRecAreas.jpg">
    <img id="markerImage" src="assets/marker.png">
    <img id="infoImage1" src="assets/info1.jpg">
    <img id="infoImage2" src="assets/info2.jpg">
  </a-assets>

  <a-camera position="0 0 0" look-controls="enabled: false">
    <a-entity cursor="fuse: true; fuseTimeout: 1000; rayOrigin: mouse;"
              raycaster="objects: .clickable"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
              material="color: #FFD700; shader: flat">
    </a-entity>
  </a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    
    <a-image src="#mapImage" position="0 0 0" width="1" height="1"></a-image>

    <a-entity position="0.3 0.2 0.05">
      <a-image class="clickable" 
               marker-handler="panelId: #panel1" 
               src="#markerImage" 
               width="0.15" height="0.15">
      </a-image>
      <a-image id="panel1" class="info-panel" src="#infoImage1" position="0 0.4 0.1" width="0.7" height="0.5" visible="false"></a-image>
    </a-entity>

    <a-entity position="-0.2 -0.1 0.05">
      <a-image class="clickable" 
               marker-handler="panelId: #panel2" 
               src="#markerImage" 
               width="0.15" height="0.15">
      </a-image>
      <a-image id="panel2" class="info-panel" src="#infoImage2" position="0 0.4 0.1" width="0.7" height="0.5" visible="false"></a-image>
    </a-entity>

  </a-entity>

</a-scene>

<script>
  const button = document.querySelector('#startButton');
  const overlay = document.querySelector('#overlay');
  button.addEventListener('click', () => {
    overlay.style.display = 'none';
    window.dispatchEvent(new Event('resize'));
  });

  // Automatically hide panels when the map is lost from view
  const mainTarget = document.querySelector('[mindar-image-target]');
  mainTarget.addEventListener("targetLost", () => {
    document.querySelectorAll('.info-panel').forEach(p => p.setAttribute('visible', false));
  });
</script>

</body>
</html>
